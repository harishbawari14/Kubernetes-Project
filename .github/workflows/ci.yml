name: Kubernetes Voting App CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Validate Kubernetes YAML files
  validate-k8s:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
        
    - name: Validate YAML syntax
      run: |
        echo "ðŸ” Validating Kubernetes YAML files..."
        for file in voting-app-k8s/*.yaml voting-app-k8s/Service/*.yaml; do
          if [ -f "$file" ]; then
            echo "Validating $file"
            kubectl --dry-run=client --validate=true apply -f "$file" || exit 1
          fi
        done
        echo "âœ… All YAML files are valid!"
        
    - name: Check for secrets in code
      run: |
        echo "ðŸ”’ Checking for hardcoded secrets..."
        if grep -r "password.*=" voting-app-k8s/ --exclude-dir=.git || \
           grep -r "secret.*=" voting-app-k8s/ --exclude-dir=.git || \
           grep -r "token.*=" voting-app-k8s/ --exclude-dir=.git; then
          echo "âŒ Found potential hardcoded secrets!"
          exit 1
        else
          echo "âœ… No hardcoded secrets found!"
        fi

  # Job 2: Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-k8s
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'voting-app-k8s/'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Job 3: Kubernetes deployment test
  k8s-deployment-test:
    name: Test Kubernetes Deployment
    runs-on: ubuntu-latest
    needs: [validate-k8s, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Start minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 1.32.0
        kubernetes-version: 1.28.0
        
    - name: Create namespace
      run: |
        kubectl create namespace vote-app-test
        
    - name: Deploy secrets and config
      run: |
        echo "ðŸ” Deploying secrets and configuration..."
        kubectl apply -f voting-app-k8s/secret.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/config.yaml -n vote-app-test
        
    - name: Deploy services
      run: |
        echo "ðŸŒ Deploying services..."
        kubectl apply -f voting-app-k8s/Service/ -n vote-app-test
        
    - name: Deploy applications
      run: |
        echo "ðŸš€ Deploying applications..."
        kubectl apply -f voting-app-k8s/postgres-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/redis-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/voting-app-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/result-app-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/worker-app-pod.yaml -n vote-app-test
        
    - name: Wait for deployments
      run: |
        echo "â³ Waiting for deployments to be ready..."
        kubectl wait --for=condition=available --timeout=300s deployment --all -n vote-app-test
        
    - name: Check deployment status
      run: |
        echo "ðŸ“Š Checking deployment status..."
        kubectl get all -n vote-app-test
        kubectl get pods -n vote-app-test -o wide
        
    - name: Test application connectivity
      run: |
        echo "ðŸ§ª Testing application connectivity..."
        
        # Test if voting service is accessible
        kubectl port-forward service/voting-service 8080:80 -n vote-app-test &
        sleep 10
        
        # Test voting app response
        if curl -f http://localhost:8080 > /dev/null 2>&1; then
          echo "âœ… Voting app is accessible!"
        else
          echo "âŒ Voting app is not accessible!"
          kubectl logs -l app=demo-voting-app,tier=frontend -n vote-app-test
          exit 1
        fi
        
    - name: Test worker connectivity
      run: |
        echo "ðŸ”§ Testing worker connectivity..."
        
        # Check worker logs for successful connections
        sleep 30  # Give worker time to start
        
        if kubectl logs -l tier=worker -n vote-app-test | grep -q "Connected to db"; then
          echo "âœ… Worker connected to database!"
        else
          echo "âŒ Worker failed to connect to database!"
          kubectl logs -l tier=worker -n vote-app-test
          exit 1
        fi
        
        if kubectl logs -l tier=worker -n vote-app-test | grep -q "Found redis"; then
          echo "âœ… Worker connected to Redis!"
        else
          echo "âŒ Worker failed to connect to Redis!"
          kubectl logs -l tier=worker -n vote-app-test
          exit 1
        fi
        
    - name: Cleanup test namespace
      if: always()
      run: |
        kubectl delete namespace vote-app-test --ignore-not-found=true

  # Job 4: Documentation check
  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README files exist
      run: |
        echo "ðŸ“š Checking documentation..."
        
        if [ ! -f "voting-app-k8s/README.md" ]; then
          echo "âŒ README.md not found!"
          exit 1
        fi
        
        if [ ! -f "voting-app-k8s/COMPLETE-ARCHITECTURE-GUIDE.md" ]; then
          echo "âŒ COMPLETE-ARCHITECTURE-GUIDE.md not found!"
          exit 1
        fi
        
        echo "âœ… All documentation files found!"
        
    - name: Check for TODO items
      run: |
        echo "ðŸ“ Checking for TODO items..."
        
        if grep -r "TODO\|FIXME\|XXX" voting-app-k8s/ --exclude-dir=.git; then
          echo "âš ï¸ Found TODO items that need attention!"
        else
          echo "âœ… No TODO items found!"
        fi

  # Job 5: Performance test (optional)
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: k8s-deployment-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Start minikube
      uses: medyagh/setup-minikube@master
      
    - name: Deploy application
      run: |
        kubectl create namespace vote-app-perf
        kubectl apply -f voting-app-k8s/ -n vote-app-perf
        kubectl wait --for=condition=available --timeout=300s deployment --all -n vote-app-perf
        
    - name: Install hey (load testing tool)
      run: |
        wget https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
        chmod +x hey_linux_amd64
        sudo mv hey_linux_amd64 /usr/local/bin/hey
        
    - name: Run load test
      run: |
        kubectl port-forward service/voting-service 8080:80 -n vote-app-perf &
        sleep 10
        
        echo "ðŸš€ Running load test..."
        hey -n 100 -c 10 http://localhost:8080 > load_test_results.txt
        
        echo "ðŸ“Š Load test results:"
        cat load_test_results.txt
        
    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: load_test_results.txt
        
    - name: Cleanup performance namespace
      if: always()
      run: |
        kubectl delete namespace vote-app-perf --ignore-not-found=true

  # Job 6: Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-k8s, security-scan, k8s-deployment-test, documentation-check]
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸŽ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Validate K8s | ${{ needs.validate-k8s.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| K8s Deployment Test | ${{ needs.k8s-deployment-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation Check | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review any failed jobs above" >> $GITHUB_STEP_SUMMARY
        echo "- Check security scan results in Security tab" >> $GITHUB_STEP_SUMMARY
        echo "- Verify all pods are running correctly" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Deployment Commands" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "kubectl create namespace vote-app" >> $GITHUB_STEP_SUMMARY
        echo "kubectl apply -f voting-app-k8s/ -n vote-app" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get pods -n vote-app" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY