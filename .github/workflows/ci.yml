name: Kubernetes Voting App CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Validate Kubernetes YAML (no real cluster)
  validate-k8s:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Validate YAML syntax
      run: |
        set -e
        echo "ðŸ” Validating Kubernetes YAML files..."

        # Force kubectl to use an empty kubeconfig so it does NOT try localhost:8080
        export KUBECONFIG=/tmp/kubeconfig
        touch "$KUBECONFIG"

        echo "Checking YAML syntax..."

        # Validate service files (client-side only)
        for file in voting-app-k8s/Service/*.yaml; do
          if [ -f "$file" ]; then
            echo "Validating syntax of $file"
            kubectl apply --dry-run=client --validate=false -f "$file" > /dev/null
          fi
        done

        # Validate config file
        echo "Validating syntax of voting-app-k8s/config.yaml"
        kubectl apply --dry-run=client --validate=false -f voting-app-k8s/config.yaml > /dev/null

        # Validate other manifests (exclude template + config)
        for file in voting-app-k8s/*.yaml; do
          if [ -f "$file" ] && [[ "$file" != *"secret-template.yaml" ]] && [[ "$file" != *"config.yaml" ]]; then
            echo "Validating syntax of $file"
            kubectl apply --dry-run=client --validate=false -f "$file" > /dev/null
          fi
        done

        echo "âœ… All YAML files have valid syntax!"

    - name: Check for secrets in code
      run: |
        echo "ðŸ”’ Checking for hardcoded secrets..."
        set +e
        if grep -r "password.*=" voting-app-k8s/ --exclude-dir=.git --exclude="*template*" | grep -v "valueFrom" || \
           grep -r "secret.*="   voting-app-k8s/ --exclude-dir=.git --exclude="*template*" | grep -v "secretKeyRef" || \
           grep -r "token.*="    voting-app-k8s/ --exclude-dir=.git --exclude="*template*"; then
          echo "âŒ Found potential hardcoded secrets!"
          exit 1
        else
          echo "âœ… No hardcoded secrets found!"
        fi

  # Job 2: Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-k8s

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'voting-app-k8s/'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Job 3: Advanced validation on Minikube
  advanced-validation:
    name: Advanced Validation
    runs-on: ubuntu-latest
    needs: validate-k8s

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 1.32.0
        kubernetes-version: 1.28.0

    - name: Validate with real cluster
      run: |
        set -e
        echo "ðŸ” Advanced validation with real cluster..."

        kubectl create namespace validation-test

        kubectl create secret generic db-credentials \
          --from-literal=username=postgres \
          --from-literal=password=postgres \
          -n validation-test

        kubectl create secret generic redis-credentials \
          --from-literal=password="" \
          -n validation-test

        kubectl apply -f voting-app-k8s/config.yaml -n validation-test
        kubectl apply -f voting-app-k8s/Service/ -n validation-test

        kubectl apply -f voting-app-k8s/postgres-pod.yaml   -n validation-test --dry-run=server
        kubectl apply -f voting-app-k8s/redis-pod.yaml      -n validation-test --dry-run=server
        kubectl apply -f voting-app-k8s/voting-app-pod.yaml -n validation-test --dry-run=server
        kubectl apply -f voting-app-k8s/result-app-pod.yaml -n validation-test --dry-run=server
        kubectl apply -f voting-app-k8s/worker-app-pod.yaml -n validation-test --dry-run=server

        echo "âœ… Advanced validation passed!"
        kubectl delete namespace validation-test --ignore-not-found=true

  # Job 4: Kubernetes deployment test (Minikube)
  k8s-deployment-test:
    name: Test Kubernetes Deployment
    runs-on: ubuntu-latest
    needs: [advanced-validation, security-scan]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 1.32.0
        kubernetes-version: 1.28.0

    - name: Create namespace and secrets
      run: |
        set -e
        kubectl create namespace vote-app-test

        kubectl create secret generic db-credentials \
          --from-literal=username=postgres \
          --from-literal=password=postgres \
          -n vote-app-test

        kubectl create secret generic redis-credentials \
          --from-literal=password="" \
          -n vote-app-test

        kubectl apply -f voting-app-k8s/config.yaml -n vote-app-test

    - name: Deploy services
      run: |
        kubectl apply -f voting-app-k8s/Service/ -n vote-app-test

    - name: Deploy applications
      run: |
        kubectl apply -f voting-app-k8s/postgres-pod.yaml   -n vote-app-test
        kubectl apply -f voting-app-k8s/redis-pod.yaml      -n vote-app-test
        kubectl apply -f voting-app-k8s/voting-app-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/result-app-pod.yaml -n vote-app-test
        kubectl apply -f voting-app-k8s/worker-app-pod.yaml -n vote-app-test

    - name: Wait for pods
      run: |
        echo "â³ Waiting for pods to be Ready..."
        kubectl wait --for=condition=Ready pod --all -n vote-app-test --timeout=300s || true

    - name: Check deployment status
      run: |
        kubectl get all -n vote-app-test
        kubectl get pods -n vote-app-test -o wide

    - name: Test application connectivity
      run: |
        set -e
        echo "ðŸ§ª Testing application connectivity..."
        kubectl port-forward service/voting-service 8080:80 -n vote-app-test &
        PF_PID=$!
        sleep 15

        if curl -f http://localhost:8080 > /dev/null 2>&1; then
          echo "âœ… Voting app is accessible!"
        else
          echo "âŒ Voting app is not accessible!"
          kubectl logs -l app=demo-voting-app,tier=frontend -n vote-app-test || true
          kill $PF_PID || true
          exit 1
        fi
        kill $PF_PID || true

    - name: Cleanup test namespace
      if: always()
      run: |
        kubectl delete namespace vote-app-test --ignore-not-found=true

  # Job 5: Documentation check
  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README files exist
      run: |
        echo "ðŸ“š Checking documentation..."
        if [ ! -f "voting-app-k8s/README.md" ]; then
          echo "âŒ README.md not found!"
          exit 1
        fi
        if [ ! -f "voting-app-k8s/COMPLETE-ARCHITECTURE-GUIDE.md" ]; then
          echo "âŒ COMPLETE-ARCHITECTURE-GUIDE.md not found!"
          exit 1
        fi
        echo "âœ… All documentation files found!"

    - name: Check for TODO items
      run: |
        echo "ðŸ“ Checking for TODO items..."
        if grep -r "TODO\|FIXME\|XXX" voting-app-k8s/ --exclude-dir=.git; then
          echo "âš ï¸ Found TODO items that need attention!"
        else
          echo "âœ… No TODO items found!"
        fi

  # Job 6: Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-k8s, advanced-validation, security-scan, k8s-deployment-test, documentation-check]
    if: always()

    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸŽ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Validate K8s | ${{ needs.validate-k8s.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Advanced Validation | ${{ needs.advanced-validation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| K8s Deployment Test | ${{ needs.k8s-deployment-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation Check | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
